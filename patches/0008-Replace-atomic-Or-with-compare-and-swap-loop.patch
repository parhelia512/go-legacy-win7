From 047b6c4781000edb13c2f362a954b94d19ddd92f Mon Sep 17 00:00:00 2001
From: Vorapol Rinsatitnon <vorapol.r@pm.me>
Date: Thu, 12 Feb 2026 04:01:42 +0700
Subject: [PATCH] Replace atomic Or with compare-and-swap loop

---
 src/cmd/compile/internal/types2/named.go |  8 +++++++-
 src/go/types/named.go                    |  8 +++++++-
 src/sync/waitgroup.go                    | 17 +++++++++++++----
 3 files changed, 27 insertions(+), 6 deletions(-)

diff --git a/src/cmd/compile/internal/types2/named.go b/src/cmd/compile/internal/types2/named.go
index 2922fb55..59f58baf 100644
--- a/src/cmd/compile/internal/types2/named.go
+++ b/src/cmd/compile/internal/types2/named.go
@@ -292,7 +292,13 @@ func (n *Named) stateHas(m stateMask) bool {
 // setState atomically sets the current state to include each active bit in sm.
 // Must only be called while holding n.mu.
 func (n *Named) setState(m stateMask) {
-	atomic.OrUint32(&n.state_, uint32(m))
+	for {
+		old := atomic.LoadUint32(&n.state_)
+		new := old | uint32(m)
+		if old == new || atomic.CompareAndSwapUint32(&n.state_, old, new) {
+			break
+		}
+	}
 	// verify state transitions
 	if debug {
 		m := stateMask(atomic.LoadUint32(&n.state_))
diff --git a/src/go/types/named.go b/src/go/types/named.go
index 3b618f40..2bcad58c 100644
--- a/src/go/types/named.go
+++ b/src/go/types/named.go
@@ -295,7 +295,13 @@ func (n *Named) stateHas(m stateMask) bool {
 // setState atomically sets the current state to include each active bit in sm.
 // Must only be called while holding n.mu.
 func (n *Named) setState(m stateMask) {
-	atomic.OrUint32(&n.state_, uint32(m))
+	for {
+		old := atomic.LoadUint32(&n.state_)
+		new := old | uint32(m)
+		if old == new || atomic.CompareAndSwapUint32(&n.state_, old, new) {
+			break
+		}
+	}
 	// verify state transitions
 	if debug {
 		m := stateMask(atomic.LoadUint32(&n.state_))
diff --git a/src/sync/waitgroup.go b/src/sync/waitgroup.go
index 29117ab9..9faa6bd5 100644
--- a/src/sync/waitgroup.go
+++ b/src/sync/waitgroup.go
@@ -94,10 +94,19 @@ func (wg *WaitGroup) Add(delta int) {
 			fatal("sync: WaitGroup.Add called from multiple synctest bubbles")
 		case synctest.CurrentBubble:
 			bubbled = true
-			state := wg.state.Or(waitGroupBubbleFlag)
-			if state != 0 && state&waitGroupBubbleFlag == 0 {
-				// Add has been called from outside this bubble.
-				fatal("sync: WaitGroup.Add called from inside and outside synctest bubble")
+			// Use compare-and-swap loop to implement atomic Or operation
+			// since race detector doesn't have __tsan_go_atomic64_fetch_or
+			for {
+				old := wg.state.Load()
+				new := old | waitGroupBubbleFlag
+				if wg.state.CompareAndSwap(old, new) {
+					state := old
+					if state != 0 && state&waitGroupBubbleFlag == 0 {
+						// Add has been called from outside this bubble.
+						fatal("sync: WaitGroup.Add called from inside and outside synctest bubble")
+					}
+					break
+				}
 			}
 		}
 	}
-- 
2.47.3

